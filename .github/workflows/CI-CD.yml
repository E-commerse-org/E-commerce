name: CI Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: read
  security-events: write
  id-token: write

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: e-commerce-app
  CONTAINER_NAME: e-commerce-container

# ======================================================
# =============== PARALLEL SECURITY SCANS ===============
# ======================================================

jobs:

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    outputs:
      gl_count: ${{ steps.gitleaks.outputs.gl_count }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Gitleaks
        id: gitleaks
        run: |
          docker run --rm -v $PWD:/repo zricethezav/gitleaks detect --source="/repo" --no-color > gitleaks.txt || true
          COUNT=$(cat gitleaks.txt | wc -l)
          echo "gl_count=$COUNT" >> $GITHUB_OUTPUT

  owasp-dependency-check:
    name: OWASP Dependency-Check
    runs-on: ubuntu-latest
    outputs:
      dc_count: ${{ steps.dc.outputs.dc_count }}
    steps:
      - uses: actions/checkout@v4

      - name: Run OWASP Dependency-Check
        id: dc
        run: |
          docker run --rm -v "$(pwd)":/src owasp/dependency-check \
          --scan /src --format "JSON" --out /src || true
          COUNT=$(jq '.dependencies | length' dependency-check-report.json)
          echo "dc_count=$COUNT" >> $GITHUB_OUTPUT

  checkov-scan:
    name: Checkov IaC Scan
    runs-on: ubuntu-latest
    outputs:
      ckv_count: ${{ steps.ckv.outputs.ckv_count }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov
        id: ckv
        run: |
          pip install checkov
          checkov -d . --output json > checkov.json || true
          COUNT=$(jq '.summary.failed' checkov.json)
          echo "ckv_count=$COUNT" >> $GITHUB_OUTPUT

# ======================================================
# ======= SECURITY SLACK SUMMARY AFTER ALL SCANS =======
# ======================================================

  notify-security:
    name: Slack Notification – Security Scan Results
    runs-on: ubuntu-latest
    needs: [secret-scanning, owasp-dependency-check, checkov-scan]
    if: always()
    steps:
      - name: Send Security Results
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GL: ${{ needs.secret-scanning.outputs.gl_count }}
          DC: ${{ needs.owasp-dependency-check.outputs.dc_count }}
          CKV: ${{ needs.checkov-scan.outputs.ckv_count }}
        run: |
          STATUS=":white_check_mark: Success"
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"*Security Scan Results*\nStatus: $STATUS\nGitleaks secrets: $GL\nOWASP Dependency-Check issues: $DC\nCheckov IaC issues: $CKV\nRepository: $GITHUB_REPOSITORY\nBranch: $GITHUB_REF_NAME\nCommit: $GITHUB_SHA\"
          }" \
          "$SLACK_WEBHOOK_URL"

# ======================================================
# ======= SONARCLOUD + DOCKER BUILD IN PARALLEL ========
# ======================================================

  sonarcloud-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run SonarCloud Scan
        run: |
          echo "Running SonarCloud..." 
          exit 1  # make it fail for testing

  build-scan-and-push:
    name: Build, Scan, Push Docker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker
        run: |
          echo "Building docker..."


# ======================================================
# ================ FINAL PIPELINE NOTIFICATIONS =========
# ======================================================

  notify-success:
    name: Slack Notification – Pipeline Success
    runs-on: ubuntu-latest
    needs: [sonarcloud-analysis, build-scan-and-push]
    if: success()
    steps:
      - name: Send Success Message
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"✅ *CI Pipeline Succeeded!*\nRepository: $GITHUB_REPOSITORY\nBranch: $GITHUB_REF_NAME\nCommit: $GITHUB_SHA\"}" \
          "$SLACK_WEBHOOK_URL"

  notify-failure:
    name: Slack Notification – Pipeline Failure
    runs-on: ubuntu-latest
    needs: [sonarcloud-analysis, build-scan-and-push]
    if: failure()
    steps:
      - name: Send Failure Message
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"❌ *CI Pipeline Failed!*\nRepository: $GITHUB_REPOSITORY\nBranch: $GITHUB_REF_NAME\nCommit: $GITHUB_SHA\"}" \
          "$SLACK_WEBHOOK_URL"
